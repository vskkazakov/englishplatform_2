<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Entertaining English - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="{% load static %}{% static 'authen/styles.css' %}?v=2.1">
    <script src="{% static 'mysite/mobile-nav.js' %}?v=1.0" defer></script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <span class="logo-text">Entertaining</span><span class="logo-accent">English</span>
            </div>
            <div class="nav">
                <a href="{% url 'index' %}" class="nav-link">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
                <a href="{% url 'dictionary:index' %}" class="nav-link">–°–ª–æ–≤–∞—Ä—å</a>
                <a href="{% url 'tests:index' %}" class="nav-link">–¢–µ—Å—Ç—ã</a>
                <a href="{% url 'act_static:index' %}" class="nav-link">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a href="{% url 'games:index' %}" class="nav-link">–ò–≥—Ä—ã</a>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            {% if user.is_authenticated %}
                <div class="user-info">
                    <span>–ü—Ä–∏–≤–µ—Ç, {{ user.first_name }}!</span>
                    <a href="{% url 'authen:logout' %}" class="logout-btn">–í—ã–π—Ç–∏</a>
                </div>
            {% endif %}

            {% if messages %}
                <div class="messages">
                    {% for message in messages %}
                        <div class="message {{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if stage == 'initial' %}
                <!-- –ù–∞—á–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø - –≤—ã–±–æ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–≤—Ö–æ–¥–∞ -->
                <div class="auth-container">
                    <div class="auth-header">
                        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Entertaining English</h1>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É</p>
                    </div>

                    <div class="tab-buttons">
                        <button class="tab-btn {% if show_registration %}active{% endif %}" onclick="showRegistration()">
                            <span class="tab-icon">üìù</span>
                            <span class="tab-text">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                        </button>
                        <button class="tab-btn {% if not show_registration %}active{% endif %}" onclick="showLogin()">
                            <span class="tab-icon">üîë</span>
                            <span class="tab-text">–í—Ö–æ–¥</span>
                        </button>
                    </div>

                    <div class="registration-form {% if show_registration %}active{% endif %}">
                        <h2>–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
                        <p class="form-description">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="register" value="1">
                            
                            <div class="form-group">
                                {{ registration_form.email.label_tag }}
                                <div class="input-wrapper">
                                    {{ registration_form.email }}
                                    <span class="input-icon">üìß</span>
                                </div>
                                {% for error in registration_form.email.errors %}
                                    <div class="error">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <button type="submit" class="btn-primary">
                                <span class="btn-icon">üöÄ</span>
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
                            </button>
                        </form>
                    </div>

                    <div class="login-form {% if not show_registration %}active{% endif %}">
                        <h2>–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                        <p class="form-description">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –¥–ª—è –≤—Ö–æ–¥–∞</p>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="login" value="1">
                            
                            <div class="form-group">
                                {{ login_form.email.label_tag }}
                                <div class="input-wrapper">
                                    {{ login_form.email }}
                                    <span class="input-icon">üìß</span>
                                </div>
                                {% for error in login_form.email.errors %}
                                    <div class="error">{{ error }}</div>
                                {% endfor %}
                            </div>

                            <button type="submit" class="btn-primary">
                                <span class="btn-icon">üîê</span>
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
                            </button>
                        </form>
                    </div>
                </div>
            
            {% elif stage == 'verification' %}
                <!-- –≠—Ç–∞–ø –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                <div class="auth-container">
                    <div class="auth-header">
                        <h1>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ Email</h1>
                        <p>–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ <strong>{{ email }}</strong></p>
                    </div>
                    
                    <form method="POST" class="verification-form">
                        {% csrf_token %}
                        <input type="hidden" name="verify_code" value="1">
                        
                        <div class="form-group">
                            <label for="id_code">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                            <div class="input-wrapper">
                                {{ code_form.code }}
                                <span class="input-icon">üî¢</span>
                            </div>
                            {% for error in code_form.code.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <button type="submit" class="btn-primary">
                            <span class="btn-icon">‚úÖ</span>
                            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                        </button>
                        
                        <button type="button" class="btn-secondary" onclick="resendCode()">
                            <span class="btn-icon">üîÑ</span>
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
                        </button>
                    </form>
                </div>
            
            {% elif stage == 'registration' %}
                <!-- –≠—Ç–∞–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email -->
                <div class="auth-container">
                    <div class="auth-header">
                        <h1>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h1>
                        <p>Email: <strong>{{ email }}</strong></p>
                    </div>
                    
                    <form method="POST" class="registration-final-form">
                        {% csrf_token %}
                        <input type="hidden" name="register_final" value="1">
                        
                        <div class="form-group">
                            <label for="id_first_name">–ò–º—è:</label>
                            <div class="input-wrapper">
                                <input 
                                    type="text" 
                                    name="first_name" 
                                    class="form-control" 
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" 
                                    required
                                    id="id_first_name">
                                <span class="input-icon">üë§</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="id_password1">–ü–∞—Ä–æ–ª—å:</label>
                            <div class="input-wrapper password-wrapper">
                                <input 
                                    type="password" 
                                    name="password1" 
                                    class="form-control" 
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                                    required
                                    id="id_password1">
                                <button type="button" class="password-toggle" onclick="togglePassword('id_password1')">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="id_password2">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è:</label>
                            <div class="input-wrapper password-wrapper">
                                <input 
                                    type="password" 
                                    name="password2" 
                                    class="form-control" 
                                    placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                                    required
                                    id="id_password2">
                                <button type="button" class="password-toggle" onclick="togglePassword('id_password2')">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                        </div>

                        <div class="form-group role-selection">
                            <label>–†–æ–ª—å:</label>
                            <div class="role-options">
                                <label class="role-option">
                                    <input type="radio" name="role" value="student" id="id_role_0" checked>
                                    <span class="role-icon">üéì</span>
                                    <span class="role-text">–£—á–µ–Ω–∏–∫</span>
                                </label>
                                
                                <label class="role-option">
                                    <input type="radio" name="role" value="teacher" id="id_role_1">
                                    <span class="role-icon">üë®‚Äçüè´</span>
                                    <span class="role-text">–£—á–∏—Ç–µ–ª—å</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn-primary">
                            <span class="btn-icon">üéâ</span>
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </form>
                </div>
            
            {% elif stage == 'login' %}
                <!-- –≠—Ç–∞–ø –≤—Ö–æ–¥–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email -->
                <div class="auth-container">
                    <div class="auth-header">
                        <h1>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h1>
                        <p>Email: <strong>{{ email }}</strong></p>
                    </div>
                    
                    <form method="POST" class="login-final-form">
                        {% csrf_token %}
                        <input type="hidden" name="login_final" value="1">
                        <input type="hidden" name="email" value="{{ email }}">
                        
                        <div class="form-group">
                            <label for="id_password">–ü–∞—Ä–æ–ª—å:</label>
                            <div class="input-wrapper password-wrapper">
                                <input 
                                    type="password" 
                                    name="password" 
                                    class="form-control" 
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                                    required
                                    id="id_password">
                                <button type="button" class="password-toggle" onclick="togglePassword('id_password')">
                                    <span class="eye-icon">üëÅÔ∏è</span>
                                </button>
                            </div>
                            {% for error in login_form.password.errors %}
                                <div class="error">{{ error }}</div>
                            {% endfor %}
                        </div>

                        <button type="submit" class="btn-primary">
                            <span class="btn-icon">üöÄ</span>
                            –í–æ–π—Ç–∏
                        </button>
                    </form>
                </div>
            {% endif %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Entertaining English</h4>
                    <p>–ò–∑—É—á–µ–Ω–∏–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —Å—Ç–∞–ª–æ –ø—Ä–æ—â–µ</p>
                </div>
                <div class="footer-section">
                    <h4>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h4>
                    <p>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞—â–∏—â–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ PostgreSQL</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function showRegistration() {
            document.querySelector('.registration-form').classList.add('active');
            document.querySelector('.login-form').classList.remove('active');
            document.querySelectorAll('.tab-btn')[0].classList.add('active');
            document.querySelectorAll('.tab-btn')[1].classList.remove('active');
        }

        function showLogin() {
            document.querySelector('.login-form').classList.add('active');
            document.querySelector('.registration-form').classList.remove('active');
            document.querySelectorAll('.tab-btn')[1].classList.add('active');
            document.querySelectorAll('.tab-btn')[0].classList.remove('active');
        }
        
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.parentNode.querySelector('.password-toggle');
            const eyeIcon = button.querySelector('.eye-icon');
            
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.textContent = 'üôà';
                button.setAttribute('title', '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å');
            } else {
                input.type = 'password';
                eyeIcon.textContent = 'üëÅÔ∏è';
                button.setAttribute('title', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
            }
        }
        
        function resendCode() {
            fetch("{% url 'authen:resend_code' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('–ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É.');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.error);
                }
            });
        }
    </script>
</body>
</html>